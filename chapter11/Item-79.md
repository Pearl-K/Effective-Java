# Item 79. 과도한 동기화는 피하라
과도한 동기화는 성능을 떨어트리고, 교착 상태에 빠트릴 수 있고, 예측하지 못한 동작을 수행할 수 있으므로 주의해야 한다.


이전 아이템에서는 적절한 동기화를 걸어야 하는 상황에 대해서 설명했다면, 여기서는 어떤 것이 과도한 동기화인지 알아야한다.


## 동기화 제어와 외계인 메서드 문제
- 응답 불가와 안전 실패를 피하려면, 동기화 메서드나 동기화 블록 안에서 제어를 절대 클라이언트에게 양도하면 안 된다.
- 예를 들어, 동기화 영역 안에서 다음 것들을 조심하라. (외부에서 온 것 통제 불가능)
    - 재정의할 수 있는 메서드 호출 금지
    - 클라이언트가 넘겨준 함수 객체 호출 금지
- 위와 같이 외부에서 와서 통제할 수 없는 메서드를 **'외계인 메서드'**라고 부른다.
- 외계인 메서드는 예측할 수 없어서 예외를 일으키거나, 교착 상태에 빠지거나, 데이터를 훼손할 수도 있다.



### 잘못된 예: 외계인 메서드를 동기화 블록 내부에서 호출


```java
public class ObservableSet<E> extends HashSet<E> {
    private final List<SetObserver<E>> observers = new ArrayList<>();

    public synchronized void addObserver(SetObserver<E> observer) {
        observers.add(observer);
    }

    public synchronized boolean add(E element) {
        boolean added = super.add(element);
        if (added) {
            for (SetObserver<E> observer : observers)
                observer.added(this, element);  // ⚠ 외계인 메서드 호출!
        }
        return added;
    }
}
```

- 위 코드는 `added()`라는 외부에서 전달받은 콜백을 동기화 블록 안에서 호출하고 있다.
- 해당 콜백 내부에서 `removeObserver()` 같은 메서드를 호출하면 교착 상태에 빠질 수 있다.


## 외계인 메서드 호출했을 때 생기는 문제 해결
- 대부분의 문제는 외계인 메서드 호출을 동기화 블록 바깥으로 옮기면 해결된다.
- 그러나 꼭 동기화를 해서 문제를 해결해야 하는지 고민해보면 좋다.
    - 읽기 전용을 위한 메서드나, 불변 상태를 유지하기 위해 깨끗한 복사본을 만들어주는 클래스 등을 활용할 수 있다.
    - ex. CopyOnWriteArrayList 가 이를 지원한다.
    - 이를 활용하면 명시적인 동기화 블럭을 지울 수 있다.


## 과도한 동기화를 피하는 기본 규칙
- 동기화 영역에서 가능한 적은 일을 수행하자.
- 동기화의 성능 부문도 따져보는 것이 중요하다.
    - 점점 언어가 발전하면서, 락을 잡고 놓는 연산의 비용은 최적화 되었다.
    - 즉, 동기화 자체의 비용은 낮아졌지만 진짜 소모 비용은 "경쟁하느라 낭비하는 시간"이다.
    - 병렬 실행 기회를 잃고, 모든 코어가 메모리를 일관되게 보려는 지연 비용을 생각해야한다.


## 동기화 지침
### 1. 동기화를 전혀 하지 말고, 그 클래스를 동시에 사용하고자 하는 클래스가 외부에서 알아서 동기화를 수행하게 만들자.
- 대표적인 예시: `java.util` 패키지 내부에 많은 클래스들


### 2. 동기화를 클래스 내부에서 수행해 스레드 안전한 클래스로 만들자.
- 대표적인 예시: `java.util.concurrent` 패키지 내부 클래스들


---
## Summary
- 교착 상태와 데이터 훼손을 피하기 위해 동기화 영역 안에서 외계인 메서드를 호출하지 말자.
- 동기화 영역 내부 작업을 최소한으로 줄이자.
- 가변 클래스를 설계할 때, 스스로 동기화해야 할지 고민하자.
    - ex. `CopyOnWriteArrayList` 활용 방식
- 과도한 동기화는 피하는 것이 좋다. (합당한 이유가 있을 때만 동기화하고, 동기화 여부를 명시하는 것이 좋음)